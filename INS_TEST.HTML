<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายการสั่งอาหารวัดคุมสัมพันธ์ (POS/KDS)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    <!-- React and Babel for JSX in HTML -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #a855f7; /* Purple */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }
        .text-gradient-purple {
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(to right, #8b5cf6, #ec4899);
        }
        /* Fix for Tailwind JIT issue when dynamic classes are used (e.g., bg-${color}-500) */
        /* Pre-defined classes to ensure they are included in the bundle */
        .bg-green-500, .bg-red-600, .bg-blue-500, .bg-emerald-500, .bg-red-500, .bg-yellow-500, .bg-indigo-500, .bg-purple-500, .bg-green-600, .bg-blue-600, .bg-purple-600, .bg-red-600, .bg-yellow-600, .bg-indigo-600 { }
        .text-green-600, .text-red-600, .text-blue-600, .text-red-700, .text-emerald-700, .text-indigo-700, .text-purple-700, .text-green-700, .text-yellow-700, .text-orange-700 { }
        .border-emerald-500, .border-indigo-500, .border-sky-500, .border-purple-500, .border-blue-500, .border-red-500, .border-orange-500 { }
        .ring-purple-500 { }
        .bg-green-100, .bg-yellow-100, .bg-red-100, .bg-purple-100, .bg-gray-100, .bg-orange-50, .bg-yellow-50, .bg-red-50 { }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 0. Global Variables for Firebase Connection (UPDATED WITH USER'S CONFIG) ---
        const __app_id = 'insfood46'; // Using projectId as app_id for Firestore paths
        const __firebase_config = JSON.stringify({
             apiKey: "AIzaSyAjhlZGUtB2KheHAZSqsqron3xY2cnQUKE",
             authDomain: "insfood46.firebaseapp.com",
             projectId: "insfood46",
             storageBucket: "insfood46.firebasestorage.app",
             messagingSenderId: "26999925796",
             appId: "1:26999925796:web:0086b07246d0fda6097cb1",
             measurementId: "G-1BJL74TYF4" // Included measurementId
        });
        const __initial_auth_token = null; // No initial token for public demo

        // --- Start React Application Code ---
        const { useState, useEffect, useMemo, useCallback } = React;
        const { createRoot } = ReactDOM;
        const { 
            initializeApp 
        } = firebase;
        const { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } = firebase.auth;
        const { 
            getFirestore, 
            doc, 
            collection, 
            query, 
            onSnapshot, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc,
            serverTimestamp,
            writeBatch,
            orderBy
        } = firebase.firestore;
        
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-restaurant-pos-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth Logic ---
        let app;
        let db;
        let auth;

        if (firebaseConfig && firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized with user config.");
        } else if (firebaseConfig) {
            console.warn("Using mock Firebase settings. Data will not persist without actual credentials.");
        }

        // Helper to construct public collection path
        const publicCollectionPath = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;

        // --- Toast Notification Component ---
        const Toast = ({ message, type, id, removeToast }) => {
            useEffect(() => {
                const timer = setTimeout(() => {
                    removeToast(id);
                }, 3000); // Auto-hide after 3 seconds
                return () => clearTimeout(timer);
            }, [id, removeToast]);

            let bgColor = 'bg-green-500';
            let icon = 'fas fa-check-circle';

            if (type === 'error') {
                bgColor = 'bg-red-600';
                icon = 'fas fa-times-circle';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500';
                icon = 'fas fa-info-circle';
            }

            return (
                <div className={`p-4 rounded-lg shadow-xl text-white flex items-center space-x-3 transition-all duration-300 transform ${bgColor} mb-2`}>
                    <i className={`${icon} text-lg`}></i>
                    <span className="font-semibold">{message}</span>
                </div>
            );
        };


        // --- Login Modal Component ---
        const LoginModal = ({ isOpen, targetView, onLoginSuccess, onClose }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            if (!isOpen) return null;

            const passwordMap = {
                'MenuAdmin': '1111',
                'Reports': '2222',
                'KDS': '3333',
            };

            const targetLabelMap = {
                'MenuAdmin': 'จัดการเมนู',
                'Reports': 'สถิติ/รายงาน',
                'KDS': 'หน้าครัว',
            };

            const handleLogin = (e) => {
                e.preventDefault();
                setError('');
                
                if (password === passwordMap[targetView]) {
                    onLoginSuccess(targetView);
                    setPassword('');
                    onClose();
                } else {
                    setError('รหัสผ่านไม่ถูกต้อง');
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all">
                        <h2 className="text-2xl font-extrabold text-indigo-700 mb-4 border-b pb-2">
                            เข้าสู่ระบบ ({targetLabelMap[targetView]})
                        </h2>
                        
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                                    placeholder="กรุณากรอกรหัสผ่าน"
                                    required
                                />
                            </div>
                            
                            {error && (
                                <div className="p-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium">
                                    {error}
                                </div>
                            )}
                            
                            <button
                                type="submit"
                                className="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-lg"
                            >
                                ยืนยันการเข้าสู่ระบบ
                            </button>
                            <button
                                type="button"
                                onClick={() => { onClose(); setPassword(''); setError(''); }}
                                className="w-full p-3 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition font-medium"
                            >
                                ยกเลิก
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Stock Replenishment Modal (NEW) ---
        const StockReplenishmentModal = ({ db, item, addToast, isOpen, onClose, userId }) => {
            const [newStock, setNewStock] = useState(item?.stock || 0);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (item) {
                    setNewStock(item.stock || 0);
                }
            }, [item]);

            if (!isOpen || !item) return null;

            const currentStock = item.stock || 0;
            const stockChange = newStock - currentStock;

            const handleSaveStock = async (e) => {
                e.preventDefault();
                const stockValue = parseInt(newStock, 10);
                if (isNaN(stockValue) || stockValue < 0) {
                    addToast('สต็อกใหม่ต้องเป็นตัวเลขจำนวนเต็มบวก', 'error');
                    return;
                }

                if (stockValue === currentStock) {
                    onClose();
                    return;
                }
                
                setLoading(true);

                const batch = writeBatch(db);
                const itemRef = doc(db, publicCollectionPath('menuItems'), item.id);

                try {
                    // 1. Update Menu Item Stock
                    batch.update(itemRef, { stock: stockValue });
                    
                    // 2. Log Inventory Event
                    batch.set(doc(collection(db, publicCollectionPath('inventoryLogs'))), {
                        itemId: item.id,
                        itemName: item.name,
                        change: stockChange,
                        oldStock: currentStock,
                        newStock: stockValue,
                        timestamp: serverTimestamp(),
                        type: stockChange > 0 ? 'Replenishment' : 'Adjustment',
                        adminId: userId,
                    });

                    await batch.commit();

                    addToast(`✅ เติมสต็อก ${item.name} สำเร็จ! สต็อกใหม่: ${stockValue}`, 'success');
                    onClose();
                } catch (error) {
                    console.error("Error updating stock and logging: ", error);
                    addToast('❌ เติมสต็อกไม่สำเร็จ! กรุณาตรวจสอบการเชื่อมต่อ', 'error');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg transform transition-all border-t-4 border-emerald-500">
                        <h2 className="text-2xl font-extrabold text-emerald-700 mb-4 border-b pb-2">
                            เติมสต็อกสินค้า: {item.name}
                        </h2>
                        
                        <form onSubmit={handleSaveStock} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">สต็อกปัจจุบัน</label>
                                    <p className="text-3xl font-black text-gray-800">{currentStock}</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">การเปลี่ยนแปลง</label>
                                    <p className={`text-3xl font-black ${stockChange >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {stockChange > 0 ? `+${stockChange}` : stockChange}
                                    </p>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700">จำนวนสต็อกใหม่</label>
                                <input
                                    type="number"
                                    value={newStock}
                                    onChange={(e) => setNewStock(parseInt(e.target.value, 10) || 0)}
                                    className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 text-2xl font-bold focus:ring-emerald-500 focus:border-emerald-500 transition duration-150"
                                    min="0"
                                    required
                                />
                            </div>
                            
                            <button
                                type="submit"
                                disabled={loading || isNaN(parseInt(newStock, 10)) || parseInt(newStock, 10) < 0}
                                className="w-full bg-emerald-600 text-white p-3 rounded-lg font-semibold hover:bg-emerald-700 transition duration-200 shadow-lg disabled:bg-gray-400 flex items-center justify-center"
                            >
                                {loading ? 'กำลังบันทึก...' : 'บันทึกสต็อกใหม่'}
                            </button>
                            <button
                                type="button"
                                onClick={onClose}
                                className="w-full p-3 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition font-medium"
                            >
                                ยกเลิก
                            </button>
                        </form>
                    </div>
                </div>
            );
        };


        // --- Menu Admin View Component ---
        const MenuAdminView = ({ db, menuItems, categories, addToast, userId }) => {
            // NEW: Added state for stock modal
            const [isStockModalOpen, setIsStockModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            
            // NEW: Added stock field
            const [newItem, setNewItem] = useState({ name: '', price: '', categoryId: '', stock: 0 }); 
            const [newCategoryName, setNewCategoryName] = useState('');
            const [message, setMessage] = useState('');

            // Function to handle opening the stock modal
            const handleOpenStockModal = (item) => {
                setEditingItem(item);
                setIsStockModalOpen(true);
            };

            // Function to add a new menu item
            const handleAddItem = async (e) => {
                e.preventDefault();
                // Check if stock is a valid number
                const stockValue = parseInt(newItem.stock, 10);
                if (!newItem.name || !newItem.price || !newItem.categoryId || isNaN(stockValue) || stockValue < 0) {
                    setMessage('กรุณากรอกข้อมูลให้ครบถ้วนและตรวจสอบสต็อก (ต้องเป็นตัวเลข >= 0)');
                    return;
                }

                try {
                    await addDoc(collection(db, publicCollectionPath('menuItems')), {
                        name: newItem.name,
                        price: parseFloat(newItem.price),
                        categoryId: newItem.categoryId,
                        stock: stockValue, // Stock included
                        createdAt: serverTimestamp(),
                    });
                    setNewItem({ name: '', price: '', categoryId: '', stock: 0 });
                    setMessage('เพิ่มรายการอาหารสำเร็จ!');
                } catch (error) {
                    console.error("Error adding document: ", error);
                    setMessage('เกิดข้อผิดพลาดในการเพิ่มรายการอาหาร');
                }
            };
            
            // Function to add a new category (FIXED: Moved up definition and made internal)
            const handleAddCategory = async (e) => {
                e.preventDefault();
                if (!newCategoryName) {
                    setMessage('กรุณากรอกชื่อหมวดหมู่');
                    return;
                }

                try {
                    await addDoc(collection(db, publicCollectionPath('categories')), {
                        name: newCategoryName,
                        order: categories.length + 1,
                    });
                    setNewCategoryName('');
                    setMessage('เพิ่มหมวดหมู่สำเร็จ!');
                } catch (error) {
                    console.error("Error adding category: ", error);
                    setMessage('เกิดข้อผิดพลาดในการเพิ่มหมวดหมู่');
                }
            };
            
            // Function to delete a menu item
            const handleDeleteItem = async (itemId) => {
                // Use custom modal or confirm logic here, using window.confirm for simplicity
                if (window.confirm('คุณแน่ใจหรือไม่ที่จะลบรายการอาหารนี้?')) {
                    try {
                        await deleteDoc(doc(db, publicCollectionPath('menuItems'), itemId));
                        setMessage('ลบรายการอาหารสำเร็จ!');
                    } catch (error) {
                        console.error("Error deleting item: ", error);
                        setMessage('เกิดข้อผิดพลาดในการลบรายการอาหาร');
                    }
                }
            };

            return (
                <div className="p-6 bg-gray-50 min-h-screen">
                    <h1 className="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">
                        จัดการเมนู (ผู้ดูแล)
                    </h1>

                    {message && (
                        <div className="mb-4 p-3 bg-indigo-100 text-indigo-700 rounded-lg shadow-md transition-all">
                            {message}
                        </div>
                    )}

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Add New Category */}
                        <div className="bg-white p-6 rounded-xl shadow-2xl col-span-1 border-t-4 border-indigo-500">
                            <h2 className="text-2xl font-bold mb-4 text-indigo-700">เพิ่มหมวดหมู่ใหม่</h2>
                            <form onSubmit={handleAddCategory} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ชื่อหมวดหมู่</label>
                                    <input
                                        type="text"
                                        value={newCategoryName}
                                        onChange={(e) => setNewCategoryName(e.target.value)}
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                                        placeholder="เช่น เครื่องดื่ม, ของหวาน"
                                    />
                                </div>
                                <button
                                    type="submit"
                                    className="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-lg transform hover:scale-[1.01]"
                                >
                                    บันทึกหมวดหมู่
                                </button>
                            </form>
                            <div className="mt-6">
                                <h3 className="text-lg font-semibold text-gray-700 mb-2">หมวดหมู่ที่มี ({categories.length})</h3>
                                <div className="flex flex-wrap gap-2">
                                    {categories.map(cat => (
                                        <span key={cat.id} className="px-3 py-1 bg-indigo-100 text-indigo-800 text-sm font-medium rounded-full">
                                            {cat.name}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Add New Item */}
                        <div className="bg-white p-6 rounded-xl shadow-2xl lg:col-span-2 border-t-4 border-emerald-500">
                            <h2 className="text-2xl font-bold mb-4 text-emerald-700">เพิ่มรายการอาหารใหม่</h2>
                            <form onSubmit={handleAddItem} className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="col-span-1 md:col-span-4">
                                    <label className="block text-sm font-medium text-gray-700">ชื่ออาหาร</label>
                                    <input
                                        type="text"
                                        value={newItem.name}
                                        onChange={(e) => setNewItem({ ...newItem, name: e.target.value })}
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150"
                                        placeholder="เช่น แกงเขียวหวาน, กาแฟเย็น"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ราคา (บาท)</label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.01"
                                        value={newItem.price}
                                        onChange={(e) => setNewItem({ ...newItem, price: e.target.value })}
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150"
                                        placeholder="เช่น 120.00"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">หมวดหมู่</label>
                                    <select
                                        value={newItem.categoryId}
                                        onChange={(e) => setNewItem({ ...newItem, categoryId: e.target.value })}
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 bg-white"
                                    >
                                        <option value="">--- เลือกหมวดหมู่ ---</option>
                                        {categories.map(cat => (
                                            <option key={cat.id} value={cat.id}>{cat.name}</option>
                                        ))}
                                    </select>
                                </div>
                                   {/* Stock Input */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">สต็อกเริ่มต้น</label>
                                    <input
                                        type="number"
                                        min="0"
                                        value={newItem.stock}
                                        onChange={(e) => setNewItem({ ...newItem, stock: e.target.value })}
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150"
                                        placeholder="เช่น 100"
                                    />
                                </div>
                                <div className="flex items-end">
                                    <button
                                        type="submit"
                                        className="w-full bg-emerald-600 text-white p-3 rounded-lg font-semibold hover:bg-emerald-700 transition duration-200 shadow-lg transform hover:scale-[1.01]"
                                    >
                                        บันทึกรายการอาหาร
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    {/* Current Menu List */}
                    <div className="mt-10 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-sky-500">
                        <h2 className="text-2xl font-bold mb-4 text-sky-700">รายการอาหารที่มีในปัจจุบัน ({menuItems.length})</h2>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-sky-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ชื่ออาหาร
                                        </th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ราคา (บาท)
                                        </th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            หมวดหมู่
                                        </th>
                                        {/* Stock Column */}
                                        <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            สต็อก
                                        </th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            จัดการ
                                        </th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {menuItems.map((item) => {
                                        const category = categories.find(c => c.id === item.categoryId) || { name: 'ไม่มีหมวดหมู่' };
                                        const isLowStock = item.stock < 10;
                                        return (
                                            <tr key={item.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.price.toFixed(2)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-sky-100 text-sky-800">
                                                        {category.name}
                                                    </span>
                                                </td>
                                                {/* Stock Display */}
                                                <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-bold">
                                                    <span className={isLowStock ? 'text-red-500' : 'text-gray-800'}>
                                                        {item.stock}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                                                    <button
                                                        onClick={() => handleOpenStockModal(item)}
                                                        className="text-blue-600 hover:text-blue-900 transition duration-150"
                                                    >
                                                        เติมสต็อก
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteItem(item.id)}
                                                        className="text-red-600 hover:text-red-900 transition duration-150"
                                                    >
                                                        ลบ
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <StockReplenishmentModal
                        db={db}
                        item={editingItem}
                        addToast={addToast}
                        isOpen={isStockModalOpen}
                        onClose={() => setIsStockModalOpen(false)}
                        userId={userId}
                    />
                </div>
            );
        };

        // --- POS (Waiter) View Component ---
        const POSView = ({ db, userId, menuItems, categories, activeTableOrders, inProductionOrders, addToast }) => { 
            const tableNumbers = useMemo(() => Array.from({ length: 40 }, (_, i) => `T${i + 1}`), []); 
            const [selectedTable, setSelectedTable] = useState('');
            const [currentOrder, setCurrentOrder] = useState([]); 
            const [currentOrderId, setCurrentOrderId] = useState(null); 
            const [specialNotes, setSpecialNotes] = useState({}); 
            const [activeCategory, setActiveCategory] = useState(null); 
            const [message, setMessage] = useState('');
            const [isCheckoutModalOpen, setIsCheckoutModalOpen] = useState(false);
            const [isIncidentModalOpen, setIsIncidentModalOpen] = useState(false); 

            // Find the order that is currently an UNPAID transaction for the selected table
            const activeOrderForSelectedTable = activeTableOrders.find(order => order.tableNumber === selectedTable);

            // Filter orders that are ready to be served
            const readyToServeOrders = useMemo(() => {
                // Find the latest order for each table that is in 'Ready' state
                const readyOrders = inProductionOrders.filter(order => order.status === 'Ready');
                
                // Group by table and take the newest one if multiple exist (though usually there should only be one 'Ready' at a time)
                const latestReadyOrdersMap = readyOrders.reduce((map, order) => {
                    if (!map[order.tableNumber] || order.timestamp.toMillis() > map[order.tableNumber].timestamp.toMillis()) {
                        map[order.tableNumber] = order;
                    }
                    return map;
                }, {});
                
                return Object.values(latestReadyOrdersMap);

            }, [inProductionOrders]);

            // Function to handle serving confirmation
            const handleServeOrder = async (orderId, tableNumber) => {
                try {
                    await updateDoc(doc(db, publicCollectionPath('orders'), orderId), {
                        status: 'Served',
                        servedBy: userId,
                        servedAt: serverTimestamp(),
                    });
                    addToast(`✅ เสิร์ฟโต๊ะ ${tableNumber} สำเร็จ!`, 'success');
                } catch (error) {
                    console.error("Error updating order status to Served: ", error);
                    addToast(`❌ เกิดข้อผิดพลาดในการเสิร์ฟโต๊ะ ${tableNumber}`, 'error');
                }
            };


            // Load existing order details when a new occupied table is selected
            useEffect(() => {
                // We only load an EXISTING order if it's an UNPAID transaction.
                if (selectedTable && activeOrderForSelectedTable) {
                    // Load items from the existing active UNPAID order
                    setCurrentOrder(activeOrderForSelectedTable.items.map(itemData => ({
                        item: { 
                            id: itemData.itemId, 
                            name: itemData.name, 
                            price: itemData.price 
                        },
                        quantity: itemData.quantity,
                        notes: itemData.specialInstructions || '',
                    })));
                    setCurrentOrderId(activeOrderForSelectedTable.id);
                    setMessage(`โต๊ะ ${selectedTable} มีออเดอร์ (ยังไม่ชำระเงิน) เปิดอยู่. สามารถเพิ่มรายการหรือชำระเงิน.`);
                } else if (selectedTable) { 
                    // If table is selected but NOT in activeTableOrders (i.e., Paid or vacant)
                    // Start a new order/transaction, even if the last one is still in production.
                    setCurrentOrder([]);
                    setCurrentOrderId(null);
                    setSpecialNotes({});
                    
                    // Check production status to give better message
                    const productionOrder = inProductionOrders.find(order => order.tableNumber === selectedTable);
                    if (productionOrder) {
                         setMessage(`โต๊ะ ${selectedTable} (สถานะครัว: ${getTableStatusLabel(selectedTable)}). เริ่มรับออเดอร์ใหม่ได้.`);
                    } else {
                         setMessage(`โต๊ะ ${selectedTable} ว่าง, เริ่มรับออเดอร์ใหม่ได้.`);
                    }
                }
            }, [selectedTable, activeOrderForSelectedTable, inProductionOrders]); // Dependency update

            const filteredItems = useMemo(() => {
                if (!activeCategory) {
                    return menuItems;
                }
                return menuItems.filter(item => item.categoryId === activeCategory);
            }, [menuItems, activeCategory]);

            // UPDATED: Check stock before adding item
            const handleAddItem = (item) => {
                const itemStock = menuItems.find(i => i.id === item.id)?.stock || 0;
                const currentQuantity = currentOrder.find(i => i.item.id === item.id)?.quantity || 0;
                
                if (itemStock <= currentQuantity) {
                    addToast(`❌ สต็อก ${item.name} หมดแล้ว! (เหลือ ${itemStock})`, 'error');
                    return;
                }

                setCurrentOrder(prevOrder => {
                    const existingItemIndex = prevOrder.findIndex(i => i.item.id === item.id);
                    if (existingItemIndex > -1) {
                        const newOrder = [...prevOrder];
                        newOrder[existingItemIndex].quantity += 1;
                        return newOrder;
                    } else {
                        return [...prevOrder, { item, quantity: 1, notes: specialNotes[item.id] || '' }];
                    }
                });
                setSpecialNotes(prev => {
                    const newNotes = { ...prev };
                    delete newNotes[item.id];
                    return newNotes;
                });
            };

            // UPDATED: Check stock when increasing quantity
            const handleQuantityChange = (itemId, change) => {
                 const itemDetails = menuItems.find(i => i.id === itemId);
                 const itemStock = itemDetails?.stock || 0;
                
                setCurrentOrder(prevOrder => {
                    const existingItemIndex = prevOrder.findIndex(i => i.item.id === itemId);
                    if (existingItemIndex > -1) {
                        const newOrder = [...prevOrder];
                        const newQuantity = newOrder[existingItemIndex].quantity + change;
                        
                        if (newQuantity <= 0) {
                            // Remove item if quantity is zero or less
                            return newOrder.filter(i => i.item.id !== itemId);
                        }
                        
                        // Check stock when incrementing
                        if (change > 0 && newQuantity > itemStock) {
                            addToast(`❌ สต็อก ${itemDetails.name} ไม่พอ! (เหลือ ${itemStock})`, 'error');
                            return prevOrder; // Do not update quantity
                        }
                        
                        newOrder[existingItemIndex].quantity = newQuantity;
                        return newOrder;
                    }
                    return prevOrder;
                });
            };

            const handleNotesChange = (itemId, notes) => {
                setCurrentOrder(prevOrder => 
                    prevOrder.map(item => 
                        item.item.id === itemId ? { ...item, notes } : item
                    )
                );
            };

            const total = currentOrder.reduce((sum, item) => sum + (item.item.price * item.quantity), 0);

            const formatOrderData = () => currentOrder.map(i => ({
                itemId: i.item.id,
                name: i.item.name,
                price: i.item.price,
                quantity: i.quantity,
                specialInstructions: i.notes,
            }));

            // Function to initiate checkout (only opens modal, does NOT write to Firestore yet)
            const handleInitiateCheckout = async () => {
                if (!selectedTable) {
                    setMessage('กรุณาเลือกหมายเลขโต๊ะ');
                    return;
                }
                
                if (currentOrder.length === 0) {
                     setMessage('ออเดอร์ว่างเปล่า ไม่สามารถชำระเงินได้');
                     return;
                }
                
                // Open modal
                setIsCheckoutModalOpen(true);
                // setMessage(`เปิดหน้าชำระเงินสำหรับโต๊ะ ${selectedTable}...`); // Handled by toast now
            };
            
            // UPDATED: Handle payment and Stock Deduction (CRITICAL SECTION)
            const handlePayment = async (paymentType) => {
                if (currentOrder.length === 0) {
                    setMessage('ออเดอร์ว่างเปล่า');
                    return;
                }

                const orderItems = formatOrderData();
                const batch = writeBatch(db);
                const orderRef = currentOrderId ? doc(db, publicCollectionPath('orders'), currentOrderId) : doc(collection(db, publicCollectionPath('orders')));

                try {
                    // 1. Pre-Check: Final check for stock availability before writing to DB
                    for (const item of currentOrder) {
                        const menuDoc = menuItems.find(m => m.id === item.item.id);
                        if (menuDoc && menuDoc.stock < item.quantity) {
                             addToast(`❌ สั่งอาหารไม่สำเร็จ! สต็อก ${item.item.name} ไม่พอ (เหลือ ${menuDoc.stock})`, 'error');
                             setIsCheckoutModalOpen(false);
                             return; // STOP transaction if stock is insufficient
                        }
                    }
                    
                    // 2. Prepare Order Data
                    const orderData = {
                        tableNumber: selectedTable,
                        items: orderItems,
                        total: total,
                        waiterId: userId,
                        paymentType: paymentType,
                        closedAt: serverTimestamp(), 
                        status: 'Pending', // Set status for kitchen to see (Production start)
                        timestamp: serverTimestamp(),
                    };

                    // 3. Update/Create Order
                    batch.set(orderRef, orderData, { merge: currentOrderId !== null });

                    // 4. Stock Deduction
                    for (const item of currentOrder) {
                        const itemRef = doc(db, publicCollectionPath('menuItems'), item.item.id);
                        const currentStock = menuItems.find(m => m.id === item.item.id)?.stock || 0;
                        
                        if (currentStock > 0) {
                             batch.update(itemRef, {
                                 stock: currentStock - item.quantity
                             });
                        }
                    }

                    // Commit all changes (Order Creation + Stock Deduction)
                    await batch.commit();
                    
                    addToast(`✅ ส่งออเดอร์ (T${selectedTable.replace('T', '')}) และชำระเงินสำเร็จ!`, 'success');

                    // Reset state after successful transaction
                    setCurrentOrder([]);
                    setCurrentOrderId(null);
                    setSelectedTable('');
                    setSpecialNotes({});
                    setIsCheckoutModalOpen(false);

                } catch (error) {
                    console.error("Error finalizing payment and submitting order: ", error);
                    addToast('❌ สั่งอาหารไม่สำเร็จ! กรุณาตรวจสอบอินเทอร์เน็ต/ฐานข้อมูล', 'error'); 
                    setIsCheckoutModalOpen(false);
                }
            };

            // --- Incident Reporting Logic ---
            const handleReportIncident = async ({ type, description }) => {
                if (!selectedTable || !type) {
                    setMessage('กรุณาเลือกโต๊ะและประเภทเหตุการณ์');
                    return;
                }

                try {
                    await addDoc(collection(db, publicCollectionPath('incidents')), {
                        tableNumber: selectedTable,
                        type: type,
                        description: description,
                        timestamp: serverTimestamp(),
                        reporterId: userId,
                        isResolved: false,
                    });
                    addToast(`แจ้งเหตุ [${type}] โต๊ะ ${selectedTable} สำเร็จ!`, 'info');
                    setIsIncidentModalOpen(false);
                } catch (error) {
                    console.error("Error reporting incident: ", error);
                    addToast('❌ แจ้งเหตุไม่สำเร็จ! กรุณาตรวจสอบอินเทอร์เน็ต', 'error');
                }
            };
            // --- END NEW ---

            const getCategoryName = (categoryId) => {
                const category = categories.find(cat => cat.id === categoryId);
                return category ? category.name : 'อื่นๆ';
            };
            
            // Helper to get table status style (uses production status for visual feedback)
            const getTableStatusStyle = (tableNumber) => {
                // Find the latest order that is still in production (Pending, Preparing, Ready, Served)
                const productionOrder = inProductionOrders.find(order => order.tableNumber === tableNumber);
                
                if (!productionOrder) return 'bg-white text-gray-700 hover:bg-green-50';
                
                switch (productionOrder.status) {
                    case 'Ready':
                    case 'Served':
                        return 'bg-green-100 text-green-700 font-bold border-2 border-green-500 hover:bg-green-200';
                    case 'Pending':
                    case 'Preparing':
                        return 'bg-yellow-100 text-yellow-700 font-bold border-2 border-yellow-500 hover:bg-yellow-200';
                    default:
                        return 'bg-white text-gray-700 hover:bg-gray-50';
                }
            };

            const getTableStatusLabel = (tableNumber) => {
                const productionOrder = inProductionOrders.find(order => order.tableNumber === tableNumber);
                if (!productionOrder) return 'ว่าง';
                
                switch (productionOrder.status) {
                    case 'Ready': return 'เสร็จพร้อมเสิร์ฟ';
                    case 'Served': return 'เสิร์ฟแล้ว';
                    case 'Pending': return 'รอทำอาหาร (ชำระแล้ว)';
                    case 'Preparing': return 'กำลังทำอาหาร (ชำระแล้ว)';
                    default: return 'ไม่ทราบสถานะ';
                }
            };

            // Checkout Modal Component (UNCHANGED)
            const CheckoutModal = () => {
                if (!isCheckoutModalOpen) return null;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all">
                            <h2 className="text-3xl font-extrabold text-blue-700 mb-4 border-b pb-2">
                                ชำระเงิน (โต๊ะ {selectedTable})
                            </h2>
                            
                            <div className="text-xl font-semibold mb-4 bg-blue-50 p-4 rounded-lg">
                                ยอดรวม: <span className="text-red-600 font-black text-3xl ml-2">{total.toFixed(2)} ฿</span>
                            </div>

                            <h3 className="text-lg font-bold mb-3 text-gray-700">เลือกวิธีการชำระเงิน</h3>
                            <div className="space-y-3">
                                <button
                                    onClick={() => handlePayment('Cash')}
                                    className="w-full p-4 bg-green-500 text-white rounded-lg font-bold text-lg hover:bg-green-600 transition shadow-lg flex items-center justify-center"
                                >
                                    <i className="fas fa-money-bill-wave mr-3"></i> เงินสด
                                </button>
                                <button
                                    onClick={() => handlePayment('Credit Card')}
                                    className="w-full p-4 bg-yellow-500 text-white rounded-lg font-bold text-lg hover:bg-yellow-600 transition shadow-lg flex items-center justify-center"
                                >
                                    <i className="fas fa-credit-card mr-3"></i> บัตรเครดิต/QR
                                </button>
                                <button
                                    onClick={() => handlePayment('Transfer')}
                                    className="w-full p-4 bg-indigo-500 text-white rounded-lg font-bold text-lg hover:bg-indigo-600 transition shadow-lg flex items-center justify-center"
                                >
                                    <i className="fas fa-exchange-alt mr-3"></i> โอนเงิน
                                </button>
                            </div>

                            <button
                                type="button" // Important: set type to button to prevent form submission issues
                                onClick={() => setIsCheckoutModalOpen(false)}
                                className="mt-6 w-full p-3 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition font-medium"
                            >
                                ยกเลิก
                            </button>
                        </div>
                    </div>
                );
            };
            
            // --- NEW: Incident Modal Component ---
            const IncidentModal = () => {
                const [type, setType] = useState('Spillage');
                const [description, setDescription] = useState('');
                
                if (!isIncidentModalOpen) return null;

                const incidentTypes = [
                    { value: 'Spillage', label: 'ทำหก/ทำแตก' },
                    { value: 'Complaint', label: 'ลูกค้าตำหนิ' },
                    { value: 'Maintenance', label: 'อุปกรณ์เสีย' },
                    { value: 'Safety', label: 'เหตุการณ์ฉุกเฉิน' },
                    { value: 'Other', label: 'อื่นๆ' },
                ];
                
                const handleSubmit = (e) => {
                    e.preventDefault();
                    handleReportIncident({ type, description });
                    setDescription('');
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all">
                            <h2 className="text-2xl font-extrabold text-red-700 mb-4 border-b pb-2">
                                แจ้งเหตุการณ์/ปัญหา (โต๊ะ {selectedTable})
                            </h2>
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ประเภทเหตุการณ์</label>
                                    <select
                                        value={type}
                                        onChange={(e) => setType(e.target.value)}
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 transition duration-150 bg-white"
                                        required
                                    >
                                        {incidentTypes.map(t => (
                                            <option key={t.value} value={t.value}>{t.label}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">รายละเอียด</label>
                                    <textarea
                                        value={description}
                                        onChange={(e) => setDescription(e.target.value)}
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-red-500 focus:border-red-500 transition duration-150 resize-none"
                                        rows="3"
                                        placeholder="กรุณาอธิบายเหตุการณ์สั้นๆ"
                                        required
                                    />
                                </div>
                                
                                <button
                                    type="submit"
                                    disabled={!selectedTable || !type || !description}
                                    className="w-full bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition duration-200 shadow-lg disabled:bg-gray-400"
                                >
                                    ส่งรายงานเหตุการณ์
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setIsIncidentModalOpen(false)}
                                    className="w-full p-3 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition font-medium"
                                >
                                    ยกเลิก
                                </button>
                            </form>
                        </div>
                    </div>
                );
            };
            // --- END NEW ---

            // Determine the button state for the simplified flow
            const isPaidTransaction = activeOrderForSelectedTable?.paymentType; 
            const isReadyToSubmit = selectedTable && currentOrder.length > 0;
            
            let buttonLabel = '';
            let buttonDisabled = true;
            let buttonColorClass = 'bg-gray-400 disabled:bg-gray-400';

            if (!selectedTable) {
                buttonLabel = 'กรุณาเลือกโต๊ะ';
            } else if (currentOrder.length === 0) {
                buttonLabel = currentOrderId ? 'เพิ่มรายการอาหาร' : 'ออเดอร์ว่างเปล่า';
                buttonDisabled = true;
            } else if (currentOrderId) {
                // Existing UNPAID order is loaded, so we are updating and paying it now
                buttonLabel = 'อัปเดตและชำระเงิน';
                buttonDisabled = !isReadyToSubmit;
                buttonColorClass = 'bg-green-600 hover:bg-green-700';
            } else {
                // New order (currentOrderId is null)
                buttonLabel = 'ส่งออเดอร์และชำระเงิน';
                buttonDisabled = !isReadyToSubmit;
                buttonColorClass = 'bg-blue-600 hover:bg-blue-700';
            }

            return (
                <div className="p-4 md:p-6 bg-gray-100 min-h-screen relative">
                    <h1 className="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2 hidden md:block">
                        หน้าสั่งอาหาร (POS - Bar Mode)
                    </h1>
                    {/* Removed internal message box for cleaner UI, relying solely on Toast */}
                    {/* {message && (...) } */}

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        {/* Table Status & Selector (UPDATED UI/GRID) */}
                        <div className="lg:col-span-1 bg-white p-4 md:p-6 rounded-xl shadow-2xl border-t-4 border-purple-500">
                            <h2 className="text-xl font-bold mb-4 text-purple-700">เลือก/ตรวจสอบสถานะโต๊ะ (40 โต๊ะ)</h2>
                            <div className="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3 max-h-[400px] overflow-y-auto p-2 border rounded-lg bg-gray-50">
                                {tableNumbers.map(table => (
                                    <button
                                        key={table}
                                        onClick={() => setSelectedTable(table)}
                                        className={`p-2 rounded-xl shadow-md text-center transition-all duration-150 transform hover:scale-[1.05]
                                            ${selectedTable === table 
                                                ? 'ring-4 ring-offset-2 ring-purple-500' 
                                                : ''
                                            } ${getTableStatusStyle(table)}`}
                                    >
                                        <span className="font-black text-lg block">{table.replace('T', '')}</span>
                                        <span className="text-xs mt-0.5 block">{getTableStatusLabel(table)}</span>
                                    </button>
                                ))}
                            </div>

                            {/* NEW: Ready to Serve List */}
                            <div className="mt-6 p-4 bg-green-50 rounded-lg shadow-lg border border-green-300">
                                <h3 className="text-lg font-bold text-green-700 mb-2 flex items-center">
                                    <i className="fas fa-bell mr-2"></i> พร้อมเสิร์ฟ ({readyToServeOrders.length})
                                </h3>
                                {readyToServeOrders.length > 0 ? (
                                    <div className="space-y-2 max-h-40 overflow-y-auto">
                                        {readyToServeOrders.map(order => (
                                            <div key={order.id} className="flex justify-between items-center p-2 bg-white rounded-lg border-l-4 border-green-500">
                                                <p className="font-bold text-gray-800">
                                                    โต๊ะ {order.tableNumber}
                                                </p>
                                                <button
                                                    onClick={() => handleServeOrder(order.id, order.tableNumber)}
                                                    className="bg-green-500 text-white px-3 py-1 text-xs rounded-lg hover:bg-green-600 transition"
                                                >
                                                    เสิร์ฟแล้ว
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-sm text-gray-500">ยังไม่มีอาหารที่ทำเสร็จ</p>
                                )}
                            </div>


                            {selectedTable && (
                                <div className="mt-4 p-3 bg-purple-600 rounded-lg text-center shadow-lg">
                                    <span className="text-xl font-bold text-white">
                                        โต๊ะที่เลือก: {selectedTable}
                                    </span>
                                    {/* Display if there's an UNPAID order for clear context */}
                                    {activeOrderForSelectedTable && !activeOrderForSelectedTable.paymentType && (
                                        <p className="text-sm text-red-200 font-semibold mt-1">
                                            มีออเดอร์รอชำระเงินอยู่!
                                        </p>
                                    )}
                                    <p className="text-sm text-gray-100 mt-1">
                                        สถานะครัว: {getTableStatusLabel(selectedTable)}
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Order Summary Panel */}
                        <div className="lg:col-span-1 bg-white rounded-xl shadow-2xl p-4 md:p-6 border-t-4 border-blue-500">
                            <h2 className="text-2xl font-bold mb-4 text-blue-700">ออเดอร์ปัจจุบัน</h2>
                            
                            {/* Order List */}
                            <div className="h-96 overflow-y-auto border-b pb-4 mb-4">
                                {currentOrder.length === 0 ? (
                                    <p className="text-center text-gray-500 py-10">
                                        ยังไม่มีรายการอาหารในออเดอร์
                                    </p>
                                ) : (
                                    currentOrder.map(itemData => {
                                        const menuStock = menuItems.find(i => i.id === itemData.item.id)?.stock || 0;
                                        return (
                                        <div key={itemData.item.id} className="flex items-center justify-between p-2 mb-2 bg-gray-50 rounded-lg shadow-sm border border-gray-200">
                                            <div className="flex-grow">
                                                <p className="font-semibold text-gray-800">{itemData.item.name}</p>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    {itemData.item.price.toFixed(2)} ฿ x {itemData.quantity}
                                                    {/* NEW: Display current stock in small text */}
                                                    <span className={`ml-2 font-medium ${menuStock < 5 ? 'text-red-500' : 'text-gray-500'}`}>
                                                        (สต็อก: {menuStock})
                                                    </span>
                                                </p>
                                                <textarea
                                                    placeholder="หมายเหตุ"
                                                    className="mt-1 w-full text-xs p-1 border rounded focus:ring-blue-500 focus:border-blue-500 transition resize-none"
                                                    value={itemData.notes}
                                                    onChange={(e) => handleNotesChange(itemData.item.id, e.target.value)}
                                                    rows="1"
                                                />
                                            </div>
                                            <div className="flex items-center space-x-1 ml-3">
                                                <button
                                                    onClick={() => handleQuantityChange(itemData.item.id, -1)}
                                                    className="bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center hover:bg-red-600 transition"
                                                >
                                                    <i className="fas fa-minus text-xs"></i>
                                                </button>
                                                <span className="font-bold w-6 text-center">{itemData.quantity}</span>
                                                <button
                                                    onClick={() => handleQuantityChange(itemData.item.id, 1)}
                                                    className="bg-green-500 text-white w-6 h-6 rounded-full flex items-center justify-center hover:bg-green-600 transition"
                                                >
                                                    <i className="fas fa-plus text-xs"></i>
                                                </button>
                                            </div>
                                        </div>
                                    );})
                                )}
                            </div>

                            {/* Total and Submission/Checkout */}
                            <div className="flex justify-between items-center text-2xl font-bold text-gray-800 mb-4">
                                <span>รวมทั้งสิ้น:</span>
                                <span className="text-red-600">{total.toFixed(2)} ฿</span>
                            </div>

                            <button
                                onClick={handleInitiateCheckout}
                                disabled={buttonDisabled}
                                className={`w-full text-white p-4 rounded-xl font-extrabold text-lg transition duration-200 shadow-xl disabled:cursor-not-allowed transform hover:scale-[1.01] ${buttonColorClass}`}
                            >
                                <i className="fas fa-hand-holding-usd mr-2"></i> {buttonLabel}
                            </button>
                            
                            {/* Incident Button */}
                            <button
                                onClick={() => { if (selectedTable) setIsIncidentModalOpen(true); else addToast('กรุณาเลือกโต๊ะก่อนแจ้งเหตุ', 'error'); }}
                                className="w-full mt-4 p-3 rounded-xl font-extrabold text-sm border border-red-500 text-red-600 hover:bg-red-50 transition duration-200 disabled:bg-gray-200 disabled:text-gray-500 disabled:border-gray-300"
                                disabled={!selectedTable}
                            >
                                <i className="fas fa-exclamation-triangle mr-2"></i> แจ้งเหตุการณ์ฉุกเฉิน/ปัญหา
                            </button>
                        </div>

                        {/* Menu Panel */}
                        <div className="lg:col-span-2 bg-white rounded-xl shadow-2xl p-4 md:p-6 flex flex-col h-full">
                            <div className="mb-4 flex flex-wrap gap-2 md:gap-4 border-b pb-4">
                                <button
                                    onClick={() => setActiveCategory(null)}
                                    className={`px-4 py-2 rounded-full font-semibold transition-colors duration-200 ${
                                        !activeCategory ? 'bg-orange-500 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-orange-100'
                                    }`}
                                >
                                    <span className="text-sm md:text-base">เมนูทั้งหมด</span>
                                </button>
                                {categories.map(cat => (
                                    <button
                                        key={cat.id}
                                        onClick={() => setActiveCategory(cat.id)}
                                        className={`px-4 py-2 rounded-full font-semibold transition-colors duration-200 ${
                                            activeCategory === cat.id ? 'bg-orange-500 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-orange-100'
                                        }`}
                                    >
                                        <span className="text-sm md:text-base">{cat.name}</span>
                                    </button>
                                ))}
                            </div>

                            <div className="flex-grow overflow-y-auto pr-2">
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                    {filteredItems.map(item => {
                                        const itemStock = item.stock || 0;
                                        const isOutOfStock = itemStock === 0;
                                        
                                        return (
                                        <div
                                            key={item.id}
                                            className={`bg-white border border-gray-200 rounded-xl shadow-lg transition-all duration-300 flex flex-col ${isOutOfStock ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-xl transform hover:scale-[1.02] cursor-pointer'}`}
                                            onClick={() => !isOutOfStock && handleAddItem(item)}
                                        >
                                            <div className="p-3 md:p-4 flex-grow">
                                                <p className="text-lg font-bold text-gray-800 truncate">{item.name}</p>
                                                <p className="text-sm text-orange-600 font-semibold mt-1">{item.price.toFixed(2)} ฿</p>
                                                <p className={`text-xs mt-1 font-semibold ${itemStock < 5 && itemStock > 0 ? 'text-red-500' : 'text-gray-500'}`}>
                                                    สต็อก: {isOutOfStock ? 'หมด' : itemStock}
                                                </p>
                                                <textarea
                                                    placeholder="หมายเหตุ (กดเพื่อพิมพ์)"
                                                    className="mt-2 w-full text-xs p-1 border rounded focus:ring-orange-500 focus:border-orange-500 transition resize-none"
                                                    value={specialNotes[item.id] || ''}
                                                    onChange={(e) => {
                                                        e.stopPropagation(); // Stop click from triggering handleAddItem
                                                        setSpecialNotes({ ...specialNotes, [item.id]: e.target.value });
                                                    }}
                                                    rows="1"
                                                />
                                            </div>
                                            <div className={`text-white text-center py-2 rounded-b-xl font-semibold text-sm ${isOutOfStock ? 'bg-gray-400' : 'bg-orange-500 hover:bg-orange-600'}`}>
                                                {isOutOfStock ? 'สินค้าหมด' : 'เพิ่ม (+1)'}
                                            </div>
                                        </div>
                                    );})}
                                    {filteredItems.length === 0 && (
                                        <div className="col-span-full p-10 text-center text-gray-500">
                                            ไม่มีรายการอาหารในหมวดหมู่นี้
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                    <CheckoutModal />
                    <IncidentModal />
                </div>
            );
        };

        // --- KDS (Kitchen Display System) View Component ---
        const KDSView = ({ db, orders, categories }) => {
            const publicCollectionPath = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;

            const updateOrderStatus = async (orderId, newStatus) => {
                try {
                    await updateDoc(doc(db, publicCollectionPath('orders'), orderId), {
                        status: newStatus,
                        updatedAt: serverTimestamp(),
                    });
                } catch (error) {
                    console.error("Error updating order status: ", error);
                }
            };

            const getStatusStyle = (status) => {
                switch (status) {
                    case 'Pending':
                        return 'bg-yellow-500 text-white';
                    case 'Preparing':
                        return 'bg-blue-500 text-white';
                    case 'Ready':
                        return 'bg-green-500 text-white animate-pulse';
                    case 'Served':
                        return 'bg-purple-500 text-white'; 
                    case 'Paid':
                        return 'bg-gray-400 text-white';
                    case 'Cancelled':
                        return 'bg-red-500 text-white';
                    default:
                        return 'bg-gray-200 text-gray-800';
                }
            };
            
            const getStatusLabel = (status) => {
                switch (status) {
                    case 'Pending': return 'รอทำอาหาร (ชำระแล้ว)';
                    case 'Preparing': return 'กำลังทำ (ชำระแล้ว)';
                    case 'Ready': return 'เสร็จแล้ว (ชำระแล้ว)';
                    case 'Served': return 'เสิร์ฟแล้ว';
                    case 'Paid': return 'ชำระเงินแล้ว';
                    case 'Cancelled': return 'ยกเลิกแล้ว';
                    default: return 'ไม่ทราบสถานะ';
                }
            };

            // Filter and sort orders for production (Pending, Preparing, Ready)
            const productionOrders = useMemo(() => orders
                .filter(order => order.status !== 'Served' && order.status !== 'Paid' && order.status !== 'Cancelled')
                .sort((a, b) => {
                    const statusOrder = { 'Pending': 1, 'Preparing': 2, 'Ready': 3 };
                    const statusA = statusOrder[a.status] || 99;
                    const statusB = statusOrder[b.status] || 99;
                    
                    if (statusA !== statusB) {
                        return statusA - statusB;
                    }
                    // Sort by creation time (timestamp) within the same status
                    return (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0);
                }), [orders]
            );

            // Group Served orders by table
            const servedOrdersGrouped = useMemo(() => {
                const servedOrders = orders.filter(order => order.status === 'Served');
                const grouped = servedOrders.reduce((acc, order) => {
                    if (!acc[order.tableNumber]) {
                        acc[order.tableNumber] = [];
                    }
                    // Sort orders for a table by newest first (if multiple served orders)
                    acc[order.tableNumber].push(order);
                    acc[order.tableNumber].sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    return acc;
                }, {});
                return grouped;
            }, [orders]);

            const closedOrders = useMemo(() => orders
                .filter(order => order.paymentType || order.status === 'Cancelled')
                .sort((a, b) => (b.closedAt?.toMillis() || b.timestamp?.toMillis() || 0) - (a.closedAt?.toMillis() || a.timestamp?.toMillis() || 0)), [orders]
            );


            return (
                <div className="p-4 md:p-6 bg-gray-900 min-h-screen">
                    <h1 className="text-3xl font-extrabold text-white mb-6 border-b border-gray-700 pb-2">
                        หน้าครัว (KDS)
                    </h1>

                    {/* Production Orders (Pending, Preparing, Ready) */}
                    <h2 className="text-2xl font-bold text-gray-300 mb-4">
                        ออเดอร์ในสายการผลิต ({productionOrders.length})
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {productionOrders.map(order => (
                            <div key={order.id} className="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-yellow-500 flex flex-col justify-between h-full">
                                <div>
                                    <div className="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                                        <span className="text-3xl font-black text-yellow-400">โต๊ะ {order.tableNumber}</span>
                                        <span className={`px-3 py-1 text-sm font-bold rounded-full ${getStatusStyle(order.status)}`}>
                                            {getStatusLabel(order.status)}
                                        </span>
                                    </div>
                                    
                                    <ul className="space-y-3 mb-4 h-48 overflow-y-auto pr-2">
                                        {order.items.map((item, index) => (
                                            <li key={index} className="flex flex-col p-2 bg-gray-700 rounded-lg">
                                                <div className="flex justify-between text-gray-100 font-semibold">
                                                    <span>{item.name}</span>
                                                    <span className="text-yellow-400">x{item.quantity}</span>
                                                </div>
                                                {item.specialInstructions && (
                                                    <p className="text-xs text-red-400 italic mt-1">
                                                        *หมายเหตุ: {item.specialInstructions}
                                                    </p>
                                                )}
                                            </li>
                                        ))}
                                    </ul>
                                    
                                    <p className="text-sm text-gray-400 mt-2">
                                        เวลาสั่ง: {order.timestamp ? new Date(order.timestamp.toMillis()).toLocaleTimeString('th-TH') : '...'}
                                    </p>
                                </div>

                                <div className="mt-4 pt-4 border-t border-gray-700 flex space-x-2">
                                    {order.status === 'Pending' && (
                                        <button 
                                            onClick={() => updateOrderStatus(order.id, 'Preparing')}
                                            className="flex-1 bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition duration-150"
                                        >
                                            เริ่มทำอาหาร
                                        </button>
                                    )}
                                    {order.status === 'Preparing' && (
                                        <button 
                                            onClick={() => updateOrderStatus(order.id, 'Ready')}
                                            className="flex-1 bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition duration-150"
                                        >
                                            เสร็จแล้ว (รอเสิร์ฟ)
                                        </button>
                                    )}
                                    {(order.status === 'Ready') && (
                                        <button 
                                            onClick={() => updateOrderStatus(order.id, 'Served')}
                                            className="flex-1 bg-purple-600 text-white p-3 rounded-lg font-bold hover:bg-purple-700 transition duration-150"
                                        >
                                            เสิร์ฟแล้ว
                                        </button>
                                    )}
                                    <button 
                                        onClick={() => updateOrderStatus(order.id, 'Cancelled')}
                                        className="w-1/4 bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition duration-150"
                                    >
                                        ยกเลิก
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {/* Served Orders Grouped by Table */}
                    <h2 className="text-2xl font-bold text-yellow-300 mt-10 mb-4 border-t border-gray-700 pt-6">
                        ออเดอร์ที่เสิร์ฟแล้ว (รอนำไปทำใหม่/ปิด)
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {Object.keys(servedOrdersGrouped).length === 0 ? (
                            <p className="text-gray-500 col-span-full">ไม่มีออเดอร์ที่ถูกเสิร์ฟแล้ว</p>
                        ) : (
                            Object.entries(servedOrdersGrouped).map(([tableNumber, orders]) => (
                                <div key={tableNumber} className="bg-gray-700 p-4 rounded-xl shadow-2xl border-t-4 border-yellow-500">
                                    <h3 className="text-2xl font-black text-yellow-400 mb-3 border-b border-gray-600 pb-2">
                                        โต๊ะ {tableNumber} ({orders.length} ออเดอร์)
                                    </h3>
                                    <div className="space-y-4 max-h-72 overflow-y-auto pr-2">
                                        {orders.map(order => (
                                            <div key={order.id} className="bg-gray-800 p-3 rounded-lg border-l-4 border-purple-400">
                                                <p className="text-sm font-semibold text-white mb-1">
                                                    ({new Date(order.timestamp?.toMillis()).toLocaleTimeString('th-TH')})
                                                    <span className="ml-2 text-xs text-gray-400">รวม: {order.total.toFixed(2)} ฿</span>
                                                </p>
                                                <ul className="list-disc list-inside text-gray-300 text-xs space-y-0.5">
                                                    {order.items.map((item, index) => (
                                                        <li key={index}>
                                                            {item.name} <span className="text-yellow-400 font-bold">x{item.quantity}</span>
                                                        </li>
                                                    ))}
                                                </ul>
                                                <div className="mt-2 flex justify-end">
                                                       <button 
                                                            onClick={() => updateOrderStatus(order.id, 'Pending')}
                                                            className="bg-indigo-600 text-white px-3 py-1 text-xs rounded-lg font-bold hover:bg-indigo-700 transition duration-150"
                                                        >
                                                            ย้ายกลับไปทำ
                                                        </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))
                        )}
                    </div>


                    {/* Closed Orders History (optional display) */}
                    <h2 className="text-2xl font-bold text-gray-300 mt-10 mb-4 border-t border-gray-700 pt-6">
                        ประวัติออเดอร์ (ชำระเงิน/ยกเลิก ล่าสุด)
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                        {closedOrders.slice(0, 8).map(order => (
                             <div key={order.id} className="bg-gray-800 p-4 rounded-lg shadow border-l-4 border-gray-500">
                                <div className="flex justify-between items-center">
                                    <span className="text-xl font-bold text-gray-400">โต๊ะ {order.tableNumber}</span>
                                    <span className={`px-2 py-0.5 text-xs font-semibold rounded ${order.paymentType ? 'bg-gray-400 text-white' : 'bg-red-500 text-white'}`}>
                                        {order.paymentType ? 'ชำระเงินแล้ว' : 'ยกเลิกแล้ว'}
                                    </span>
                                </div>
                                <p className="text-sm text-gray-500 mt-1">
                                    {order.items.length} รายการ | {order.total.toFixed(2)} ฿
                                </p>
                                <p className="text-xs text-gray-600 mt-1">
                                    ปิด: {order.closedAt ? new Date(order.closedAt.toMillis()).toLocaleTimeString('th-TH') : '...'}
                                </p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };


        // --- Reports View Component ---
        const ReportsView = ({ orders, incidents, menuItems, inventoryLogs }) => { // inventoryLogs added here
            // Threshold for problematic orders stuck in production
            const thresholdHours = 4; 

            const publicCollectionPath = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;

            // NEW FUNCTION to update incident status
            const toggleIncidentResolved = async (incidentId, isResolved) => {
                try {
                    await updateDoc(doc(db, publicCollectionPath('incidents'), incidentId), {
                        isResolved: !isResolved,
                        resolvedAt: !isResolved ? serverTimestamp() : null,
                    });
                } catch (error) {
                    console.error("Error updating incident status: ", error);
                }
            };
            
            // Memoized calculation for overall statistics and best sellers
            const { totalRevenue, totalItemsOrdered, orderCount, paidOrderCount, bestSellingItems, problematicOrders, lowStockItems } = useMemo(() => {
                let revenue = 0;
                let itemsCount = 0;
                let count = orders.length;
                let paidCount = 0;
                const itemSalesMap = {};
                const now = Date.now();
                const problemList = [];

                orders.forEach(order => {
                    // Financial Stats (Revenue)
                    if (order.paymentType) {
                         revenue += order.total || 0;
                         paidCount += 1;
                    }
                    
                    // Sales Stats (Best Sellers)
                    if (order.items && Array.isArray(order.items)) {
                        order.items.forEach(item => {
                            const itemName = item.name;
                            const quantity = item.quantity || 0;
                            itemsCount += quantity;
                            itemSalesMap[itemName] = (itemSalesMap[itemName] || 0) + quantity;
                        });
                    }
                    
                    // Problematic Orders Check
                    // 1. Cancelled Orders
                    if (order.status === 'Cancelled') {
                        problemList.push(order);
                    }
                    
                    // 2. Orders stuck in production for too long
                    const isProductionStatus = order.status === 'Pending' || order.status === 'Preparing' || order.status === 'Ready' || order.status === 'Served';
                    
                    if (isProductionStatus && order.timestamp) {
                        const orderTime = order.timestamp.toMillis();
                        const ageHours = (now - orderTime) / (1000 * 60 * 60);
                        if (ageHours > thresholdHours) {
                            problemList.push(order);
                        }
                    }
                });

                // Low Stock Check
                const lowStockList = menuItems.filter(item => item.stock <= 5)
                                             .sort((a, b) => a.stock - b.stock);

                // Convert map to array and sort by quantity (Best Sellers)
                const sortedItems = Object.entries(itemSalesMap)
                    .map(([name, quantity]) => ({ name, quantity }))
                    .sort((a, b) => b.quantity - a.quantity);
                
                // Sort problematic orders by oldest first (timestamp)
                problemList.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));


                return {
                    totalRevenue: revenue,
                    totalItemsOrdered: itemsCount,
                    orderCount: count,
                    paidOrderCount: paidCount,
                    bestSellingItems: sortedItems.slice(0, 5), // Top 5
                    problematicOrders: problemList.slice(0, 10), // Top 10 problematic orders
                    lowStockItems: lowStockList,
                };
            }, [orders, menuItems]);

            // NEW: Function to export reports to CSV
            const exportToCSV = (reportName, data, columns) => {
                if (data.length === 0) {
                    alert("ไม่มีข้อมูลสำหรับส่งออก");
                    return;
                }

                const csvRows = [];
                // Header
                const headers = columns.map(col => col.header).join(',');
                csvRows.push(headers);

                // Data rows
                data.forEach(item => {
                    const values = columns.map(col => {
                        let value = item[col.key];
                        
                        // Special formatting for nested/timestamp fields
                        if (col.key === 'timestamp' || col.key === 'closedAt' || col.key === 'resolvedAt') {
                            value = item[col.key] ? new Date(item[col.key].toMillis()).toLocaleString('th-TH') : '';
                        } else if (col.key === 'items') {
                            value = item.items.map(i => `${i.name} (x${i.quantity})`).join('; ');
                        } else if (col.key === 'description' && item.description) {
                            // Escape internal quotes and wrap in quotes
                            value = `"${item.description.replace(/"/g, '""')}"`;
                        } else if (col.key === 'isResolved') {
                             value = item.isResolved ? 'Yes' : 'No';
                        }


                        // Ensure no commas break CSV unless enclosed properly
                        if (typeof value === 'string' && !value.startsWith('"')) {
                            value = value.replace(/,/g, ''); 
                        }

                        return value;
                    });
                    csvRows.push(values.join(','));
                });

                const csvString = csvRows.join('\n');
                
                // Download logic
                const blob = new Blob(['\ufeff', csvString], { type: 'text/csv;charset=utf-8;' }); // \ufeff is for BOM, ensures Thai characters display correctly in Excel
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', `${reportName}_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Define columns for different exports
            const orderColumns = [
                { header: 'ID', key: 'id' },
                { header: 'โต๊ะ', key: 'tableNumber' },
                { header: 'รายการสินค้า', key: 'items' },
                { header: 'ยอดรวม', key: 'total' },
                { header: 'สถานะ', key: 'status' },
                { header: 'วิธีชำระเงิน', key: 'paymentType' },
                { header: 'พนักงาน', key: 'waiterId' },
                { header: 'เวลาสั่ง', key: 'timestamp' },
                { header: 'เวลาปิดบิล', key: 'closedAt' },
            ];
            
            const inventoryLogColumns = [
                { header: 'ID', key: 'id' },
                { header: 'สินค้า', key: 'itemName' },
                { header: 'ประเภท', key: 'type' },
                { header: 'เปลี่ยนแปลง', key: 'change' },
                { header: 'สต็อกเก่า', key: 'oldStock' },
                { header: 'สต็อกใหม่', key: 'newStock' },
                { header: 'ผู้บันทึก (ID)', key: 'adminId' },
                { header: 'เวลา', key: 'timestamp' },
            ];

            const incidentColumns = [
                { header: 'ID', key: 'id' },
                { header: 'โต๊ะ', key: 'tableNumber' },
                { header: 'ประเภท', key: 'type' },
                { header: 'รายละเอียด', key: 'description' },
                { header: 'สถานะ', key: 'isResolved' },
                { header: 'เวลาแจ้ง', key: 'timestamp' },
            ];


            return (
                <div className="p-6 bg-gray-50 min-h-screen">
                    <h1 className="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2 flex justify-between items-center">
                        สถิติและรายงานสรุป
                        {/* NEW: Export Button */}
                           <button
                            onClick={() => exportToCSV('AllOrdersReport', orders, orderColumns)}
                            className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md text-sm"
                        >
                            <i className="fas fa-file-export mr-2"></i> ส่งออกรายงานทั้งหมด (.CSV)
                        </button>
                    </h1>

                    {/* Main Stats Cards */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <StatCard 
                            title="รายได้รวมทั้งหมด (ออเดอร์ที่ชำระเงินแล้ว)" 
                            value={`${totalRevenue.toFixed(2)} ฿`}
                            icon="fas fa-chart-line"
                            color="green"
                        />
                        <StatCard 
                            title="จำนวนรายการอาหารที่สั่งทั้งหมด" 
                            value={`${totalItemsOrdered.toLocaleString()} รายการ`}
                            icon="fas fa-cubes"
                            color="indigo"
                        />
                           <StatCard 
                            title="จำนวนออเดอร์ทั้งหมด (ทุกสถานะ)" 
                            value={`${orderCount} ออเดอร์`}
                            icon="fas fa-receipt"
                            color="blue"
                        />
                        <StatCard 
                            title="จำนวนออเดอร์ที่ชำระเงินแล้ว" 
                            value={`${paidOrderCount} ออเดอร์`}
                            icon="fas fa-check-circle"
                            color="purple"
                        />
                    </div>

                    {/* Visualizations and Problematic Tables */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
                        
                        {/* 1. Best Selling Items (Visual + List) - 2/3 column span */}
                        <div className="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-indigo-500 lg:col-span-2">
                            <h2 className="text-2xl font-bold mb-4 text-indigo-700">
                                รายการอาหารขายดีที่สุด 5 อันดับแรก
                            </h2>
                            
                            {bestSellingItems.length === 0 ? (
                                <p className="text-gray-500">ยังไม่มีข้อมูลการขาย</p>
                            ) : (
                                   <div className="space-y-4">
                                       {/* Simple Bar Chart Visualization */}
                                       {bestSellingItems.map((item, index) => {
                                            const maxQuantity = bestSellingItems[0].quantity;
                                            const widthPercentage = (item.quantity / maxQuantity) * 100;
                                            return (
                                                <div key={index} className="flex items-center space-x-3">
                                                    <span className="font-semibold w-1/4 text-gray-700 truncate">{item.name}</span>
                                                    <div className="flex-grow bg-gray-200 rounded-full h-6">
                                                        <div 
                                                            className={`h-6 rounded-full text-xs font-bold flex items-center justify-end px-2 transition-all duration-500 
                                                            ${index === 0 ? 'bg-indigo-600' : index < 3 ? 'bg-indigo-400' : 'bg-indigo-300'}`}
                                                            style={{ width: `${widthPercentage}%` }}
                                                        >
                                                            <span className="text-white drop-shadow-md">{item.quantity}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                            )}
                        </div>
                        
                        {/* 2. Low Stock Alert (NEW) - 1/3 column span */}
                           <div className="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-orange-500 lg:col-span-1">
                                <h2 className="text-2xl font-bold mb-4 text-orange-700">
                                    <i className="fas fa-warehouse mr-2"></i> สต็อกต่ำ (ต่ำกว่า 5)
                                </h2>
                                <div className="max-h-96 overflow-y-auto space-y-3">
                                    {lowStockItems.length === 0 ? (
                                        <p className="text-gray-500">สต็อกสินค้าอยู่ในระดับที่ปลอดภัย</p>
                                    ) : (
                                        lowStockItems.map(item => (
                                            <div key={item.id} className="p-3 border rounded-lg bg-orange-50 border-orange-200 flex justify-between items-center">
                                                <p className="font-bold text-gray-800 truncate">{item.name}</p>
                                                <span className="font-black text-xl text-red-600">
                                                    {item.stock}
                                                </span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>

                    </div>
                    
                    {/* 3. Incident Reports & Problematic Orders */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                        {/* 3a. Problematic Orders/Tables */}
                           <div className="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-red-500">
                                <h2 className="text-2xl font-bold mb-4 text-red-700">
                                    รายการ/โต๊ะที่มีปัญหา (ยกเลิก หรือค้างนานเกิน {thresholdHours} ชม.)
                                </h2>
                                <div className="max-h-96 overflow-y-auto space-y-3">
                                    {problematicOrders.length === 0 ? (
                                        <p className="text-gray-500">ไม่มีออเดอร์ที่มีปัญหาในปัจจุบัน</p>
                                    ) : (
                                        problematicOrders.map(order => {
                                            const isCancelled = order.status === 'Cancelled';
                                            const orderAgeMs = Date.now() - (order.timestamp?.toMillis() || Date.now());
                                            const orderAgeHours = (orderAgeMs / (1000 * 60 * 60)).toFixed(1);
                                            
                                            return (
                                                <div key={order.id} className={`p-3 border rounded-lg shadow-sm flex justify-between items-start 
                                                    ${isCancelled ? 'bg-red-50 border-red-200' : 'bg-yellow-50 border-yellow-200'}`}
                                                >
                                                    <div>
                                                        <p className="font-bold text-gray-800">โต๊ะ {order.tableNumber} - {order.status === 'Cancelled' ? 'ยกเลิก' : 'ค้างนาน'}</p>
                                                        <p className="text-sm text-gray-600 mt-0.5">
                                                            {isCancelled ? (
                                                                <span className="text-red-600">ยกเลิกออเดอร์ ({order.items.length} รายการ)</span>
                                                            ) : (
                                                                <span className="text-yellow-600">สถานะ: {order.status} ({orderAgeHours} ชม.)</span>
                                                            )}
                                                        </p>
                                                    </div>
                                                    <i className={`text-xl ${isCancelled ? 'fas fa-times-circle text-red-500' : 'fas fa-hourglass-half text-yellow-500'}`}></i>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        
                        {/* 3b. Incident Reports */}
                        <div className="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-red-500">
                            <h2 className="text-2xl font-bold mb-4 text-gray-800">
                                <i className="fas fa-exclamation-triangle text-red-500 mr-2"></i> รายงานเหตุการณ์/ปัญหา
                                <button 
                                    onClick={() => exportToCSV('IncidentReport', incidents, incidentColumns)}
                                    className="bg-red-500 text-white px-2 py-1 text-xs rounded-lg font-semibold hover:bg-red-600 ml-3 transition"
                                >
                                    ส่งออก
                                </button>
                            </h2>
                            <div className="max-h-96 overflow-y-auto space-y-3">
                                {incidents.length === 0 ? (
                                    <p className="text-gray-500">ไม่มีรายงานเหตุการณ์ที่ถูกบันทึก</p>
                                ) : (
                                    incidents.map(incident => (
                                        <div key={incident.id} className={`p-4 rounded-lg shadow-md border ${incident.isResolved ? 'bg-gray-100 border-gray-300' : 'bg-red-50 border-red-400'}`}>
                                            <div className="flex justify-between items-start">
                                                <p className={`text-lg font-bold ${incident.isResolved ? 'text-gray-600' : 'text-red-700'}`}>
                                                    โต๊ะ {incident.tableNumber} - {incident.type}
                                                </p>
                                                <button 
                                                    onClick={() => toggleIncidentResolved(incident.id, incident.isResolved)}
                                                    className={`px-2 py-1 text-xs rounded-full transition ${incident.isResolved ? 'bg-gray-500 text-white hover:bg-gray-600' : 'bg-yellow-500 text-white hover:bg-yellow-600'}`}
                                                >
                                                    {incident.isResolved ? '✅ แก้ไขแล้ว' : '🔔 รอแก้ไข'}
                                                </button>
                                            </div>
                                            <p className="text-sm mt-1 italic text-gray-700">
                                                "{incident.description || 'ไม่มีรายละเอียด'}"
                                            </p>
                                            <p className="text-xs text-gray-500 mt-2">
                                                แจ้งเมื่อ: {incident.timestamp ? new Date(incident.timestamp.toMillis()).toLocaleString('th-TH') : 'N/A'}
                                            </p>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* 4. Inventory Log Table (NEW SECTION) */}
                    <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 mt-10 flex justify-between items-center">
                        ประวัติการเคลื่อนไหวสต็อกสินค้า
                        <button
                            onClick={() => exportToCSV('InventoryLogReport', inventoryLogs, inventoryLogColumns)}
                            className="bg-emerald-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-700 transition duration-200 shadow-md text-sm"
                        >
                            <i className="fas fa-file-export mr-2"></i> ส่งออก
                        </button>
                    </h2>
                    <div className="bg-white p-6 rounded-xl shadow-2xl">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            รายการสินค้า
                                        </th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ประเภท
                                        </th>
                                        <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            เปลี่ยนแปลง
                                        </th>
                                        <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            สต็อกใหม่
                                        </th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            เวลา
                                        </th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {inventoryLogs.map((log) => (
                                        <tr key={log.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{log.itemName}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{log.type}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-bold">
                                                <span className={log.change > 0 ? 'text-green-600' : 'text-red-600'}>
                                                    {log.change > 0 ? `+${log.change}` : log.change}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-gray-800">{log.newStock}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {log.timestamp ? new Date(log.timestamp.toMillis()).toLocaleString('th-TH') : 'N/A'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>


                    <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 mt-10">
                        ประวัติออเดอร์ทั้งหมด
                    </h2>
                    <div className="bg-white p-6 rounded-xl shadow-2xl">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            โต๊ะ
                                        </th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            เวลาสั่ง
                                        </th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            รายการ
                                        </th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ยอดรวม
                                        </th>
                                        <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            สถานะ
                                        </th>
                                        <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            วิธีชำระเงิน
                                        </th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {orders.map((order) => {
                                        const statusColors = {
                                            'Pending': 'bg-yellow-100 text-yellow-800',
                                            'Preparing': 'bg-blue-100 text-blue-800',
                                            'Ready': 'bg-green-100 text-green-800',
                                            'Served': 'bg-purple-100 text-purple-800',
                                            'Paid': 'bg-gray-200 text-gray-800',
                                            'Cancelled': 'bg-red-100 text-red-800',
                                        };
                                        const statusLabels = {
                                            'Pending': 'รอทำอาหาร (ชำระแล้ว)',
                                            'Preparing': 'กำลังทำ (ชำระแล้ว)',
                                            'Ready': 'เสร็จแล้ว (ชำระแล้ว)',
                                            'Served': 'เสิร์ฟแล้ว',
                                            'Paid': 'ชำระเงินแล้ว',
                                            'Cancelled': 'ยกเลิกแล้ว',
                                        };

                                        return (
                                            <tr key={order.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{order.tableNumber}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {order.timestamp ? new Date(order.timestamp.toMillis()).toLocaleString('th-TH') : 'N/A'}
                                                </td>
                                                <td className="px-6 py-4 text-sm text-gray-500">
                                                    {order.items.map(item => `${item.name} (x${item.quantity})`).join(', ')}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-800">
                                                    {order.total.toFixed(2)} ฿
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center">
                                                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${order.paymentType ? 'bg-green-100 text-green-800' : statusColors[order.status]}`}>
                                                        {order.paymentType ? 'ชำระเงินแล้ว' : statusLabels[order.status]}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-600">
                                                    {order.paymentType || '-'}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // Helper component for statistics card
        const StatCard = ({ title, value, icon, color }) => (
            <div className={`p-6 bg-white rounded-xl shadow-xl border-t-4 border-${color}-500 flex items-center transform hover:scale-[1.02] transition duration-300`}>
                <div className={`flex-shrink-0 p-3 rounded-full bg-${color}-100 text-${color}-600`}>
                    <i className={`${icon} text-xl`}></i>
                </div>
                <div className="ml-4">
                    <p className="text-sm font-medium text-gray-500 truncate">{title}</p>
                    <p className="text-2xl font-extrabold text-gray-900">{value}</p>
                </div>
            </div>
        );


        // --- Main App Component ---
        const App = () => {
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [currentView, setCurrentView] = useState('POS'); // 'POS', 'KDS', 'MenuAdmin', 'Reports'
            
            // Auth States for Restricted Views 
            const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
            const [loginTarget, setLoginTarget] = useState(null);
            const [authRole, setAuthRole] = useState({
                KDS: false,
                Reports: false,
                MenuAdmin: false
            });

            // Real-time Data States
            const [menuItems, setMenuItems] = useState([]);
            const [categories, setCategories] = useState([]);
            const [orders, setOrders] = useState([]);
            const [incidents, setIncidents] = useState([]); 
            const [inventoryLogs, setInventoryLogs] = useState([]); // NEW

            // Toast state (NEW)
            const [toasts, setToasts] = useState([]);
            const addToast = useCallback((message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            }, []);
            const removeToast = useCallback((id) => {
                setToasts(prev => prev.filter(toast => toast.id !== id));
            }, []);

            // Compute active orders for POS table status lookup
            const activeTableOrders = useMemo(() => orders.filter(o => !o.paymentType && o.status !== 'Cancelled'), [orders]);

            // inProductionOrders: All orders that the kitchen is still working on (non-Served, non-Cancelled) for table status visualization.
            const inProductionOrders = useMemo(() => orders.filter(o => 
                o.status !== 'Served' && o.status !== 'Cancelled'
            ), [orders]); 
            
            // --- Authentication Logic ---
            const handleNavClick = (viewName) => {
                if (viewName === 'POS') {
                    setCurrentView('POS');
                    return;
                }

                if (authRole[viewName]) {
                    setCurrentView(viewName);
                } else {
                    setLoginTarget(viewName);
                    setIsLoginModalOpen(true);
                }
            };
            
            const handleLoginSuccess = (viewName) => {
                setAuthRole(prev => ({ ...prev, [viewName]: true }));
                setCurrentView(viewName);
            };


            // --- 1. Firebase Initialization ---
            useEffect(() => {
                if (!firebaseConfig || !db || !auth) {
                    console.error("Firebase config is missing or not initialized.");
                    setIsAuthReady(true); // Still set ready for local testing
                    return;
                }

                const signIn = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Authentication failed:", error);
                    }
                };

                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        setUserId(null);
                    }
                    setIsAuthReady(true);
                });

                signIn();
                return () => unsubscribe();
            }, []); // Run only once on mount

            // --- 2. Firestore Real-time Data Listeners ---
            useEffect(() => {
                if (!isAuthReady || !db) return;

                const publicCollectionPath = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;

                // Listener for Menu Items
                const qItems = query(collection(db, publicCollectionPath('menuItems')), orderBy('name'));
                const unsubscribeItems = onSnapshot(qItems, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMenuItems(items);
                }, (error) => console.error("Error fetching menu items:", error));

                // Listener for Categories
                const qCategories = query(collection(db, publicCollectionPath('categories')), orderBy('order', 'asc'));
                const unsubscribeCategories = onSnapshot(qCategories, (snapshot) => {
                    const cats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCategories(cats);
                }, (error) => console.error("Error fetching categories:", error));

                // Listener for Orders
                const qOrders = collection(db, publicCollectionPath('orders'));
                const unsubscribeOrders = onSnapshot(qOrders, (snapshot) => {
                     // Fetch all data and sort client-side to avoid Firestore index issues on `orderBy`
                    const orderList = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(),
                    })).sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)); // Sort by newest first for App state
                    setOrders(orderList);
                }, (error) => console.error("Error fetching orders:", error));
                
                // Listener for Incidents
                const qIncidents = query(collection(db, publicCollectionPath('incidents')), orderBy('timestamp', 'desc'));
                const unsubscribeIncidents = onSnapshot(qIncidents, (snapshot) => {
                    const incidentList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setIncidents(incidentList);
                }, (error) => console.error("Error fetching incidents:", error));

                // Listener for Inventory Logs (NEW)
                const qInventoryLogs = query(collection(db, publicCollectionPath('inventoryLogs')), orderBy('timestamp', 'desc'));
                const unsubscribeInventoryLogs = onSnapshot(qInventoryLogs, (snapshot) => {
                    const logList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setInventoryLogs(logList);
                }, (error) => console.error("Error fetching inventory logs:", error));


                return () => {
                    unsubscribeItems();
                    unsubscribeCategories();
                    unsubscribeOrders();
                    unsubscribeIncidents();
                    unsubscribeInventoryLogs(); // Cleanup new listener
                };
            }, [isAuthReady, db]);

            if (!isAuthReady) {
                return (
                    <div className="flex justify-center items-center min-h-screen bg-gray-200">
                        <p className="text-xl font-semibold text-gray-700">กำลังโหลดระบบ...</p>
                    </div>
                );
            }

            const renderView = () => {
                if (!db || (firebaseConfig && firebaseConfig.projectId === "YOUR_PROJECT_ID")) {
                    return (
                        <div className="p-10 text-center text-red-600 bg-red-100 rounded-lg m-10 border border-red-400 shadow-lg">
                            <p className="text-2xl font-bold">⚠️ ข้อผิดพลาด: การตั้งค่า Firebase ไม่สมบูรณ์</p>
                            <p className="mt-4 text-gray-700">
                                ไม่สามารถเชื่อมต่อฐานข้อมูลได้ **กรุณาแทนที่ค่า YOUR\_API\_KEY/YOUR\_PROJECT\_ID** ในโค้ด **`__firebase_config`** ด้วยค่า Firebase Config จริงของคุณเพื่อให้ระบบทำงานและบันทึกข้อมูลได้
                            </p>
                            <p className="mt-2 text-sm text-gray-500">
                                ในการใช้งานจริง, ข้อมูลจะถูกดึง/บันทึกแบบ Real-time ผ่าน Firestore
                            </p>
                        </div>
                    );
                }
                
                switch (currentView) {
                    case 'POS':
                        return <POSView 
                            db={db} 
                            userId={userId} 
                            menuItems={menuItems} 
                            categories={categories} 
                            activeTableOrders={activeTableOrders} 
                            inProductionOrders={inProductionOrders} 
                            addToast={addToast} // Pass addToast function
                        />;
                    case 'KDS':
                        return <KDSView db={db} orders={orders} categories={categories} />;
                    case 'MenuAdmin':
                        return <MenuAdminView db={db} menuItems={menuItems} categories={categories} addToast={addToast} userId={userId} />;
                    case 'Reports':
                        // FIXED: Ensure correct props are passed.
                        return <ReportsView orders={orders} incidents={incidents} menuItems={menuItems} inventoryLogs={inventoryLogs} />; 
                    default:
                        return <h1 className="text-3xl p-10">เลือกมุมมองที่ต้องการ</h1>;
                }
            };

            return (
                <div className="font-sans">
                    {/* Top Navigation */}
                    <nav className="bg-white shadow-lg sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16">
                                <div className="flex items-center">
                                    {/* UPDATED: Change logo text and style */}
                                    <span className="text-2xl font-extrabold text-gray-900 tracking-wider text-gradient-purple drop-shadow-md">
                                        รายการสั่งอาหารวัดคุมสัมพันธ์
                                    </span>
                                    <span className="ml-4 text-xs text-gray-500 hidden sm:inline">
                                        User ID: {userId ? userId.substring(0, 8) + '...' : 'N/A'}
                                    </span>
                                </div>
                                <div className="flex items-center space-x-2 md:space-x-4">
                                    <NavButton 
                                        currentView={currentView} 
                                        viewName="POS" 
                                        label="หน้าสั่งอาหาร" 
                                        icon="fas fa-cash-register"
                                        onClick={() => handleNavClick('POS')}
                                    />
                                    <NavButton 
                                        currentView={currentView} 
                                        viewName="KDS" 
                                        label="หน้าครัว (KDS)" 
                                        icon="fas fa-utensils"
                                        onClick={() => handleNavClick('KDS')}
                                    />
                                    <NavButton 
                                        currentView={currentView} 
                                        viewName="MenuAdmin" 
                                        label="จัดการเมนู" 
                                        icon="fas fa-cog"
                                        onClick={() => handleNavClick('MenuAdmin')}
                                    />
                                    <NavButton 
                                        currentView={currentView} 
                                        viewName="Reports" 
                                        label="สถิติ/รายงาน" 
                                        icon="fas fa-chart-bar"
                                        onClick={() => handleNavClick('Reports')}
                                    />
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main>
                        {renderView()}
                    </main>
                    
                    <LoginModal
                        isOpen={isLoginModalOpen}
                        targetView={loginTarget}
                        onLoginSuccess={handleLoginSuccess}
                        onClose={() => setIsLoginModalOpen(false)}
                    />
                    
                    {/* Toast Container (NEW) */}
                    <div className="fixed bottom-4 right-4 z-50 flex flex-col items-end space-y-2">
                        {toasts.map(toast => (
                            <Toast 
                                key={toast.id} 
                                id={toast.id} 
                                message={toast.message} 
                                type={toast.type}
                                removeToast={removeToast}
                            />
                        ))}
                    </div>
                </div>
            );
        };

        // Helper component for navigation buttons
        const NavButton = ({ currentView, viewName, label, icon, onClick }) => (
            <button
                onClick={onClick}
                className={`px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center shadow-md
                    ${currentView === viewName 
                        ? 'bg-purple-600 text-white transform scale-105 shadow-purple-400/50' 
                        : 'text-gray-600 hover:bg-gray-100 hover:text-purple-600' // Use purple hover for better brand consistency
                    }`}
            >
                <i className={`${icon} mr-2 hidden sm:inline`}></i>
                {label}
            </button>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>

    <!-- Firebase Library Imports (Mandatory for HTML conversion) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            auth: { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged },
            firestore: { getFirestore, doc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, writeBatch, orderBy }
        };
    </script>
</body>
</html>